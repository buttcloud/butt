version: "3"
services:
  peer-server:
    image: buttcloud/butt-peer-server:v1.0.1
    ports:
      - "8008:8008"
    environment:
      - ssb_host=peer-server
    volumes:
      - ssb:/home/node/.ssb
    deploy:
      restart_policy:
        condition: on-failure

  landing:
    image: buttcloud/butt-landing:v1.0.3
    environment:
      - ssb_host=peer-server
      - ssb_landing__host=landing
      - VIRTUAL_HOST=${HOST:-example.butt.nz}
    volumes:
      - ssb:/home/node/.ssb
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.port=8901"
        - "traefik.docker.network=default"
        - "traefik.frontend.rule=Host:${HOST:-example.butt.nz}"
      restart_policy:
        condition: on-failure

  reverse-proxy:
    image: traefik
    command:
      - --api
      - --entryPoints='Name:http Address::80 Redirect.EntryPoint:https'
      - --entryPoints='Name:https Address::443 TLS'
      - --docker
      - --docker.swarmmode
      - --docker.domain=traefik
      - --docker.watch
      - --docker.exposedbydefault=false
      - --acme.email=michael.williams@enspiral.com
      - --acme.storage=acme.json
      - --acme.entryPoint=https
      - --acme.onDemand=true
      - --acme.OnHostRule=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # the web ui enabled by --api
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    cap_drop:
      - all
    cap_add:
      - net_bind_service
    deploy:
      placement:
        constraints: [node.role == manager]
      restart_policy:
        condition: on-failure

volumes:
  ssb:
  traefik-conf:
  nginx-vhost:
  nginx-html:
  nginx-certs:
  nginx-htpasswd:
